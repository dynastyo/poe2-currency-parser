<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dynos Lazy Pickit Generator</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Roboto", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #141318;
        color: #b8b8bf;
        padding: 24px;
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      h1 {
        text-align: center;
        margin-bottom: 40px;
        font-size: 2.5em;
        font-weight: 400;
        color: #bebaff;
        letter-spacing: -0.5px;
      }

      .config-panel {
        background: #141318;
        border: 1px solid #38373d;
        border-radius: 12px;
        padding: 32px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
      }

      .input-group {
        margin-bottom: 24px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-size: 0.875em;
        font-weight: 500;
        color: #b8b8bf;
        letter-spacing: 0.1px;
      }

      input[type="number"] {
        width: 100%;
        padding: 16px;
        font-size: 1em;
        background: #141318;
        border: 1px solid #38373d;
        border-radius: 8px;
        color: #b8b8bf;
        font-family: "Roboto", sans-serif;
        transition: all 0.2s ease;
      }

      input[type="number"]:hover {
        border-color: #bebaff;
      }

      input[type="number"]:focus {
        outline: none;
        border-color: #bebaff;
        border-width: 2px;
        padding: 15px;
      }

      .button-container {
        text-align: center;
        margin-top: 32px;
      }

      button {
        padding: 16px 48px;
        font-size: 0.875em;
        font-weight: 500;
        background: #bebaff;
        color: #38373d;
        border: none;
        border-radius: 24px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
        font-family: "Roboto", sans-serif;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      button:hover {
        background: #bdbaff84;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(0, 0, 0, 0.23);
      }

      button:active {
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
      }

      button:disabled {
        background: #e0e0e0;
        color: #9e9e9e;
        cursor: not-allowed;
        box-shadow: none;
      }

      .console {
        background: #464257;
        border: 1px solid #38373d;
        border-radius: 12px;
        padding: 24px;
        margin-top: 24px;
        min-height: 400px;
        max-height: 600px;
        overflow-y: auto;
        font-size: 0.875em;
        line-height: 1.6;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
        display: none;
        font-family: "Courier New", monospace;
      }

      .console.active {
        display: block;
      }

      .console-output {
        white-space: pre-wrap;
        word-break: break-word;
        color: #bebaff;
      }

      .console-log {
        color: #9e9e9e;
        margin-bottom: 4px;
      }

      .console-error {
        color: #ff5252;
        font-weight: 500;
      }

      .console-success {
        color: #bebaff;
        font-weight: 500;
      }

      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(0, 0, 0, 0.2);
        border-radius: 50%;
        border-top-color: #b8b8bf;
        animation: spin 0.8s ease-in-out infinite;
        margin-left: 8px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .download-btn {
        padding: 12px 32px;
        font-size: 0.875em;
        margin-bottom: 16px;
        background: #bebaff;
        color: #141318;
        display: none;
      }

      .download-btn.visible {
        display: inline-block;
      }

      .download-btn:hover {
        background: rgb(86, 116, 227);
      }

      .info-text {
        color: #757575;
        font-size: 0.75em;
        margin-top: 6px;
        font-weight: 400;
      }

      .categories-group {
        margin-bottom: 24px;
        padding: 20px;
        background: #141318;
        border-radius: 8px;
        border: 1px solid #38373d;
      }

      .categories-group > label {
        margin-bottom: 12px;
        font-size: 0.875em;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .toggle-all-btn {
        font-size: 0.75em;
        color: #bebaff;
        cursor: pointer;
        text-decoration: underline;
        font-weight: normal;
      }

      .toggle-all-btn:hover {
        color: rgb(76, 106, 217);
      }

      .categories-checkboxes {
        display: grid;
        grid-template-columns: repeat(auto-fill);
        gap: 12px;
      }

      .category-section {
        margin-bottom: 20px;
      }

      .category-section-title {
        font-weight: 600;
        color: #b8b8bf;
        margin-bottom: 10px;
        padding: 8px;
        background: #38373d;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .category-toggle-btn {
        font-size: 0.75em;
        color: #bebaff;
        cursor: pointer;
        text-decoration: underline;
        font-weight: normal;
      }

      .category-toggle-btn:hover {
        color: rgb(76, 106, 217);
      }

      .subcategories-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 8px;
        margin-top: 8px;
        padding-left: 20px;
      }

      .category-input-row {
        padding: 8px 20px;
        margin-top: 5px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .category-input-row label {
        font-size: 0.85em;
        color: #666;
        margin: 0;
      }

      .category-input-row input {
        width: 60px;
        padding: 4px 8px;
        font-size: 0.85em;
        border: 1px solid #38373d;
        border-radius: 4px;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .checkbox-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: #bebaff;
      }

      .checkbox-item label {
        margin: 0;
        cursor: pointer;
        font-weight: 400;
        color: #b8b8bf;
      }

      .checkbox-item input[type="checkbox"]:disabled + label {
        color: #9e9e9e;
        cursor: not-allowed;
      }

      /* Scrollbar styling */
      .console::-webkit-scrollbar {
        width: 8px;
      }

      .console::-webkit-scrollbar-track {
        background: #1a1a1a;
      }

      .console::-webkit-scrollbar-thumb {
        background: #bebaff;
        border-radius: 4px;
      }

      .console::-webkit-scrollbar-thumb:hover {
        background: rgb(86, 116, 227);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>⚔️ Dynos Lazy Pickit Generator ⚔️</h1>

      <div class="config-panel">
        <div class="categories-group">
          <label>
            <span>Currency Categories:</span>
            <span class="toggle-all-btn" onclick="toggleAllNinja()"
              >Check all/none</span
            >
          </label>
          <div id="ninjaCategoriesCheckboxes" class="categories-checkboxes">
            <!-- Ninja categories will be loaded dynamically -->
          </div>
          <p class="info-text">Select currency and item categories</p>
        </div>

        <div class="categories-group">
          <label>
            <span>Unique Items:</span>
            <span class="toggle-all-btn" onclick="toggleAllScout()"
              >Check all/none</span
            >
          </label>
          <div id="scoutCategoriesCheckboxes" class="categories-checkboxes">
            <!-- Scout categories will be loaded dynamically -->
          </div>
          <p class="info-text">Select unique item categories</p>
        </div>

        <div class="categories-group">
          <label>
            <span>Static Filters:</span>
            <span class="toggle-all-btn" onclick="toggleAllStatic()"
              >Check all/none</span
            >
          </label>
          <div id="staticCategoriesCheckboxes" class="categories-checkboxes">
            <!-- Static categories will be loaded dynamically -->
          </div>
          <p class="info-text">Fixed filter rules for common items</p>
        </div>

        <div class="input-group">
          <label for="min_value">Minimum Exalted Value (General):</label>
          <input type="number" id="min_value" value="10" step="0.1" min="0" />
          <p class="info-text">
            Minimum exalted value for Fragments, Abyss, Gems, etc.
          </p>
        </div>

        <div class="input-group">
          <label for="min_value_currency"
            >Minimum Exalted Value (Currency):</label
          >
          <input
            type="number"
            id="min_value_currency"
            value="1"
            step="0.1"
            min="0"
          />
          <p class="info-text">
            Minimum exalted value specifically for currency items
          </p>
        </div>

        <div class="button-container">
          <button id="startBtn" onclick="startProcessing()">
            Start Processing
          </button>
        </div>
      </div>

      <div id="console" class="console">
        <div class="button-container">
          <button
            id="downloadBtn"
            class="download-btn"
            onclick="downloadResult()"
          >
            📥 Download Results
          </button>
        </div>
        <div id="consoleOutput"></div>
      </div>
    </div>

    <script>
      let currentResult = "";
      let ninjaCategories = [];
      let scoutCategories = [];
      let staticCategories = [];

      // Load available categories on page load
      async function loadCategories() {
        try {
          const response = await fetch("/categories");

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          ninjaCategories = data.categories.ninja;
          scoutCategories = data.categories.scout;
          staticCategories = data.categories.static;

          // Load Ninja categories
          const ninjaContainer = document.getElementById(
            "ninjaCategoriesCheckboxes"
          );
          ninjaContainer.innerHTML = "";

          data.categories.ninja.forEach((category) => {
            const div = document.createElement("div");
            div.className = "checkbox-item";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.id = `ninja_${category.id}`;
            checkbox.value = category.id;
            checkbox.checked = true; // Check all by default
            checkbox.disabled = category.required; // Disable Currency checkbox

            const label = document.createElement("label");
            label.htmlFor = `ninja_${category.id}`;
            label.textContent = category.name;

            div.appendChild(checkbox);
            div.appendChild(label);
            ninjaContainer.appendChild(div);
          });

          // Load Scout categories
          const scoutContainer = document.getElementById(
            "scoutCategoriesCheckboxes"
          );
          scoutContainer.innerHTML = "";

          data.categories.scout.forEach((category) => {
            const div = document.createElement("div");
            div.className = "checkbox-item";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.id = `scout_${category.id}`;
            checkbox.value = category.id;
            checkbox.checked = true; // Check Scout by default
            checkbox.disabled = category.required;

            const label = document.createElement("label");
            label.htmlFor = `scout_${category.id}`;
            label.textContent = category.name;

            div.appendChild(checkbox);
            div.appendChild(label);
            scoutContainer.appendChild(div);
          });

          // Load Static categories with subcategories
          const staticContainer = document.getElementById(
            "staticCategoriesCheckboxes"
          );
          staticContainer.innerHTML = "";

          data.categories.static.forEach((category) => {
            const section = document.createElement("div");
            section.className = "category-section";

            // Category title with toggle button
            const titleDiv = document.createElement("div");
            titleDiv.className = "category-section-title";

            const titleSpan = document.createElement("span");
            titleSpan.textContent = category.name;

            const toggleBtn = document.createElement("span");
            toggleBtn.className = "category-toggle-btn";
            toggleBtn.textContent = "Check all/none";
            toggleBtn.onclick = () => toggleStaticCategory(category.id);

            titleDiv.appendChild(titleSpan);
            titleDiv.appendChild(toggleBtn);

            // Add input field row for categories that need it (like Waystones)
            let inputRow = null;
            if (category.has_input) {
              inputRow = document.createElement("div");
              inputRow.className = "category-input-row";

              const inputLabel = document.createElement("label");
              inputLabel.textContent = `${category.input_label}:`;
              inputLabel.htmlFor = `static_input_${category.id}`;

              const input = document.createElement("input");
              input.type = category.input_type;
              input.id = `static_input_${category.id}`;
              input.min = category.input_min;
              input.max = category.input_max;
              input.value = category.input_default;

              inputRow.appendChild(inputLabel);
              inputRow.appendChild(input);
            }

            // Subcategories list
            const subcatList = document.createElement("div");
            subcatList.className = "subcategories-list";
            subcatList.id = `static_subcats_${category.id}`;

            category.subcategories.forEach((subcat) => {
              const div = document.createElement("div");
              div.className = "checkbox-item";

              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.id = `static_${category.id}_${subcat.id}`;
              checkbox.value = subcat.id;
              checkbox.checked = true; // Check by default
              checkbox.dataset.category = category.id;

              const label = document.createElement("label");
              label.htmlFor = `static_${category.id}_${subcat.id}`;
              label.textContent = subcat.name;

              div.appendChild(checkbox);
              div.appendChild(label);
              subcatList.appendChild(div);
            });

            section.appendChild(titleDiv);
            if (inputRow) {
              section.appendChild(inputRow);
            }
            section.appendChild(subcatList);
            staticContainer.appendChild(section);
          });
        } catch (error) {
          console.error("Failed to load categories:", error);
        }
      }

      function addConsoleLog(message, type = "log") {
        const consoleOutput = document.getElementById("consoleOutput");
        const div = document.createElement("div");
        div.className = `console-${type}`;
        div.textContent = message;
        consoleOutput.appendChild(div);

        // Auto-scroll to bottom
        const consoleEl = document.getElementById("console");
        consoleEl.scrollTop = consoleEl.scrollHeight;
      }

      function clearConsole() {
        document.getElementById("consoleOutput").innerHTML = "";
      }

      async function startProcessing() {
        const minValue = parseFloat(document.getElementById("min_value").value);
        const minValueCurrency = parseFloat(
          document.getElementById("min_value_currency").value
        );
        const startBtn = document.getElementById("startBtn");
        const consoleEl = document.getElementById("console");

        // Get selected Ninja categories
        const selectedNinjaCategories = [];
        ninjaCategories.forEach((category) => {
          const checkbox = document.getElementById(`ninja_${category.id}`);
          if (checkbox && checkbox.checked) {
            selectedNinjaCategories.push(category.id);
          }
        });

        // Get selected Scout categories
        const selectedScoutCategories = [];
        scoutCategories.forEach((category) => {
          const checkbox = document.getElementById(`scout_${category.id}`);
          if (checkbox && checkbox.checked) {
            selectedScoutCategories.push(category.id);
          }
        });

        // Get selected Static subcategories (grouped by category)
        const selectedStaticCategories = {};
        staticCategories.forEach((category) => {
          const selectedSubcats = [];
          category.subcategories.forEach((subcat) => {
            const checkbox = document.getElementById(
              `static_${category.id}_${subcat.id}`
            );
            if (checkbox && checkbox.checked) {
              selectedSubcats.push(subcat.id);
            }
          });
          if (selectedSubcats.length > 0) {
            selectedStaticCategories[category.id] = selectedSubcats;
          }
        });

        // Get waystone tier input
        const waystoneTierInput = document.getElementById(
          "static_input_Waystones"
        );
        const waystoneTier = waystoneTierInput
          ? parseInt(waystoneTierInput.value)
          : 1;

        // Validate inputs
        if (isNaN(minValue) || isNaN(minValueCurrency)) {
          alert("Please enter valid numbers for minimum values");
          return;
        }

        if (
          selectedNinjaCategories.length === 0 &&
          selectedScoutCategories.length === 0 &&
          Object.keys(selectedStaticCategories).length === 0
        ) {
          alert("Please select at least one category");
          return;
        }

        // Show console and clear previous output
        consoleEl.classList.add("active");
        clearConsole();

        // Hide download button
        document.getElementById("downloadBtn").classList.remove("visible");

        // Disable button and show loading
        startBtn.disabled = true;
        startBtn.innerHTML = 'Processing<span class="spinner"></span>';

        try {
          const response = await fetch("/process", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              min_value: minValue,
              min_value_currency: minValueCurrency,
              ninja_categories: selectedNinjaCategories,
              scout_categories: selectedScoutCategories,
              static_categories: selectedStaticCategories,
              waystone_tier: waystoneTier,
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          if (data.success) {
            // Only display the final result (not the processing logs)
            const resultDiv = document.createElement("div");
            resultDiv.className = "console-output";
            resultDiv.textContent = data.result;
            document.getElementById("consoleOutput").appendChild(resultDiv);

            // Store result for download
            currentResult = data.result;

            // Show download button
            document.getElementById("downloadBtn").classList.add("visible");
          } else {
            addConsoleLog(`Error: ${data.error}`, "error");
          }
        } catch (error) {
          addConsoleLog(`Fatal error: ${error.message}`, "error");
        } finally {
          // Re-enable button
          startBtn.disabled = false;
          startBtn.innerHTML = "Start Processing";
        }
      }

      function downloadResult() {
        if (!currentResult) {
          alert("No results to download. Please run the parser first.");
          return;
        }

        const blob = new Blob([currentResult], { type: "text/plain" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "currency_exalted_values.txt";
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        addConsoleLog("✓ Results downloaded successfully!", "success");
      }

      // Allow Enter key to start processing
      document.addEventListener("keypress", function (event) {
        if (
          event.key === "Enter" &&
          !document.getElementById("startBtn").disabled
        ) {
          startProcessing();
        }
      });

      // Toggle all Ninja checkboxes
      function toggleAllNinja() {
        const checkboxes = ninjaCategories
          .map((cat) => document.getElementById(`ninja_${cat.id}`))
          .filter((cb) => cb && !cb.disabled);
        if (checkboxes.length === 0) return;

        const allChecked = checkboxes.every((cb) => cb.checked);
        checkboxes.forEach((cb) => (cb.checked = !allChecked));
      }

      // Toggle all Scout checkboxes
      function toggleAllScout() {
        const checkboxes = scoutCategories
          .map((cat) => document.getElementById(`scout_${cat.id}`))
          .filter((cb) => cb && !cb.disabled);
        if (checkboxes.length === 0) return;

        const allChecked = checkboxes.every((cb) => cb.checked);
        checkboxes.forEach((cb) => (cb.checked = !allChecked));
      }

      // Toggle all Static checkboxes (all subcategories across all categories)
      function toggleAllStatic() {
        const allCheckboxes = [];
        staticCategories.forEach((cat) => {
          cat.subcategories.forEach((subcat) => {
            const checkbox = document.getElementById(
              `static_${cat.id}_${subcat.id}`
            );
            if (checkbox) allCheckboxes.push(checkbox);
          });
        });

        if (allCheckboxes.length === 0) return;

        const allChecked = allCheckboxes.every((cb) => cb.checked);
        allCheckboxes.forEach((cb) => (cb.checked = !allChecked));
      }

      // Toggle checkboxes for a specific static category
      function toggleStaticCategory(categoryId) {
        const category = staticCategories.find((cat) => cat.id === categoryId);
        if (!category) return;

        const checkboxes = category.subcategories
          .map((subcat) =>
            document.getElementById(`static_${categoryId}_${subcat.id}`)
          )
          .filter((cb) => cb);

        if (checkboxes.length === 0) return;

        const allChecked = checkboxes.every((cb) => cb.checked);
        checkboxes.forEach((cb) => (cb.checked = !allChecked));
      }

      // Load categories when page loads
      window.addEventListener("DOMContentLoaded", loadCategories);
    </script>
  </body>
</html>
